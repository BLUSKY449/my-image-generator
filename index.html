<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI: Generator Gambar Datar 2D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container-card {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

<div class="container-card w-full max-w-full text-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Gemini AI Image Generator</h1>
    <p class="text-gray-600 mb-6">Masukkan deskripsi gambar 2D datar yang ingin Anda buat, lalu tekan tombol.</p>
    
    <div class="space-y-4">
        <input 
            type="text" 
            id="promptInput" 
            placeholder="Contoh: Seekor kucing kartun sedang tidur di atas buku" 
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        
        <!-- New menu for Count and Size -->
        <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
            <div class="flex items-center gap-2">
                <label for="imageCount" class="text-gray-600 font-semibold">Count</label>
                <input 
                    type="number" 
                    id="imageCount" 
                    value="4" 
                    min="1" 
                    max="4"
                    class="w-20 px-3 py-2 border border-gray-300 rounded-xl text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
            </div>
            <div class="flex items-center gap-2">
                <label for="imageSize" class="text-gray-600 font-semibold">Size</label>
                <input 
                    type="number" 
                    id="imageSize" 
                    value="4000" 
                    min="1"
                    class="w-24 px-3 py-2 border border-gray-300 rounded-xl text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
            </div>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-4">
            <button 
                id="refineBtn" 
                class="w-full sm:w-1/2 bg-purple-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-105 active:scale-100"
            >
                âœ¨ Perbaiki Deskripsi
            </button>
            <button 
                id="generateBtn" 
                class="w-full sm:w-1/2 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 active:scale-100"
            >
                Hasilkan Gambar
            </button>
        </div>
    </div>

    <div id="loadingIndicator" class="mt-8 hidden flex justify-center">
        <div class="spinner"></div>
    </div>

    <div id="imageGallerySection" class="mt-8 hidden">
        <div class="flex justify-end mb-4">
            <button id="downloadAllBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-xl shadow-md hover:bg-gray-300 transition duration-300">
                Unduh Semua
            </button>
        </div>
        <div id="imageContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 justify-items-center">
        </div>
    </div>

    <div id="message" class="mt-8 text-red-500 font-medium hidden"></div>

</div>

<script>
    const promptInput = document.getElementById('promptInput');
    const refineBtn = document.getElementById('refineBtn');
    const generateBtn = document.getElementById('generateBtn');
    const imageCountInput = document.getElementById('imageCount');
    const imageSizeInput = document.getElementById('imageSize');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const imageGallerySection = document.getElementById('imageGallerySection');
    const imageContainer = document.getElementById('imageContainer');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const message = document.getElementById('message');

    // URLs API untuk Gemini
    const textApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
    const imageApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=";
    
    // GANTI BARIS DI BAWAH INI DENGAN KUNCI API ANDA!
    // Kunjungi Google AI Studio untuk mendapatkan kunci API:
    // https://aistudio.google.com/app/apikey
    // CATATAN PENTING: Untuk menggunakan API gambar (imagen-3.0-generate-002),
    // Anda harus mengaktifkan penagihan pada akun Google Cloud Anda.
    const apiKey = "";

    refineBtn.addEventListener('click', refinePrompt);
    generateBtn.addEventListener('click', generateImage);
    downloadAllBtn.addEventListener('click', downloadAllImages);

    // Fungsi untuk memperbaiki prompt menggunakan Gemini LLM
    async function refinePrompt() {
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) {
            showMessage("Tolong masukkan deskripsi gambar terlebih dahulu.", 'text-red-500');
            return;
        }

        loadingIndicator.classList.remove('hidden');
        imageGallerySection.classList.add('hidden');
        message.classList.add('hidden');

        let retries = 0;
        const maxRetries = 3;
        const baseDelay = 1000;

        while (retries < maxRetries) {
            try {
                const payload = {
                    contents: [{
                        parts: [{
                            text: `Anda adalah asisten kreatif untuk generator gambar. Perbaiki prompt ini agar lebih detail, deskriptif, dan kreatif untuk menghasilkan gambar 2D datar: "${userPrompt}"`
                        }]
                    }]
                };

                const response = await fetch(textApiUrl + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    const errorMessage = errorBody?.error?.message || response.statusText;
                    throw new Error(`Kesalahan API: ${errorMessage}`);
                }

                const result = await response.json();
                const refinedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (refinedText) {
                    promptInput.value = refinedText;
                    showMessage("Deskripsi berhasil diperbaiki!", 'text-green-500');
                    break;
                } else {
                    throw new Error("Tidak ada teks yang diterima.");
                }

            } catch (error) {
                console.error("Kesalahan dalam memperbaiki prompt:", error);
                if (retries < maxRetries - 1) {
                    await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, retries)));
                    retries++;
                } else {
                    showMessage(`Gagal memperbaiki deskripsi. Coba lagi. Kesalahan: ${error.message}`, 'text-red-500');
                }
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
    }

    // Fungsi untuk menghasilkan gambar menggunakan Gemini LLM
    async function generateImage() {
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) {
            showMessage("Tolong masukkan deskripsi gambar.", 'text-red-500');
            return;
        }

        const count = parseInt(imageCountInput.value, 10);
        const size = parseInt(imageSizeInput.value, 10);
        if (isNaN(count) || count < 1 || count > 4) { // Batas maksimal 4
            showMessage("Jumlah gambar harus antara 1 dan 4.", 'text-red-500');
            return;
        }
        if (isNaN(size) || size < 1) {
            showMessage("Ukuran gambar harus berupa angka yang valid.", 'text-red-500');
            return;
        }

        loadingIndicator.classList.remove('hidden');
        imageGallerySection.classList.add('hidden');
        message.classList.add('hidden');
        imageContainer.innerHTML = ''; // Hapus gambar sebelumnya

        // Perbarui teks tombol untuk indikasi "Hasilkan Lagi"
        generateBtn.textContent = `Hasilkan Lagi (hingga ${count} Gambar)`;

        let retries = 0;
        const maxRetries = 3;
        const baseDelay = 1000;

        while (retries < maxRetries) {
            try {
                const payload = {
                    instances: {
                        prompt: `gaya datar, 2d, minimalis, tanpa bayangan, unik, orisinal, dengan detail yang tidak biasa, dan hindari klise: ${userPrompt}`
                    },
                    parameters: {
                        "sampleCount": count
                    }
                };

                const response = await fetch(imageApiUrl + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    const errorMessage = errorBody?.error?.message || response.statusText;
                    throw new Error(`Kesalahan API: ${errorMessage}`);
                }
                
                const rawResponse = await response.text();
                if (!rawResponse) {
                    throw new Error("Respons API kosong.");
                }

                const result = JSON.parse(rawResponse);
                
                const imageDataArray = result?.predictions;

                if (imageDataArray && imageDataArray.length > 0) {
                    imageDataArray.forEach((prediction, index) => {
                        const imageData = prediction.bytesBase64Encoded;
                        const imageUrl = `data:image/png;base64,${imageData}`;
                        
                        const imageWrapper = document.createElement('div');
                        imageWrapper.classList = 'relative group';

                        const imgElement = document.createElement('img');
                        imgElement.src = imageUrl;
                        imgElement.alt = `Gambar yang dihasilkan ${index + 1}`;
                        imgElement.classList = 'w-full rounded-xl shadow-md border border-gray-200 transition-transform duration-300 group-hover:scale-105';

                        const downloadBtn = document.createElement('a');
                        downloadBtn.href = imageUrl;
                        downloadBtn.download = `gemini_image_${index + 1}.png`;
                        downloadBtn.classList = 'absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-white text-gray-800 text-xs font-semibold py-1 px-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300';
                        downloadBtn.textContent = 'Unduh';

                        imageWrapper.appendChild(imgElement);
                        imageWrapper.appendChild(downloadBtn);
                        imageContainer.appendChild(imageWrapper);
                    });

                    imageGallerySection.classList.remove('hidden');
                    showMessage("Gambar berhasil dibuat!", 'text-green-500');
                    break; 
                } else {
                    showMessage("API berhasil dihubungi, namun tidak ada gambar yang dikembalikan. Ini bisa terjadi jika prompt Anda terlalu spesifik atau ada batasan konten.", 'text-yellow-600');
                    break; 
                }

            } catch (error) {
                console.error("Kesalahan dalam menghasilkan gambar:", error);
                if (retries < maxRetries - 1) {
                    await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, retries)));
                    retries++;
                } else {
                    showMessage(`Gagal membuat gambar. Silakan coba lagi. Kesalahan: ${error.message}`, 'text-red-500');
                }
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
    }

    function downloadAllImages() {
        const images = document.querySelectorAll('#imageContainer img');
        if (images.length === 0) {
            showMessage("Tidak ada gambar untuk diunduh.", 'text-red-500');
            return;
        }

        let downloadedCount = 0;
        showMessage("Mengunduh semua gambar. Ini mungkin memakan waktu...", 'text-blue-500');

        images.forEach((img, index) => {
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `gemini_image_${index + 1}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                downloadedCount++;

                if (downloadedCount === images.length) {
                    showMessage("Semua gambar berhasil diunduh.", 'text-green-500');
                }
            }, 500 * index); // Jeda 500ms antar unduhan
        });
    }

    function showMessage(text, colorClass) {
        message.textContent = text;
        message.className = `mt-8 font-medium hidden ${colorClass}`;
        message.classList.remove('hidden');
    }
</script>

</body>
</html>
